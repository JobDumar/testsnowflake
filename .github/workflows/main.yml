name: Deploy to Snowflake with schemachange

on:
  push:
    branches:
      - main  # Se ejecutarÃ¡ cuando hagas push en la rama main
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”¹ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”¹ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ðŸ”¹ Instalar dependencias
        run: |
          pip install schemachange snowflake-connector-python

      - name: ðŸ”¹ Crear archivo connections.toml
        run: |
          echo '[connections.snowflake]' > connections.toml
          echo 'account = "aia76005.east-us-2.azure"' >> connections.toml
          echo 'user = "DUMAR"' >> connections.toml
          echo 'password = "dfVTkMMXXskFH8w"' >> connections.toml
          echo 'role = "ACCOUNTADMIN"' >> connections.toml
          echo 'warehouse = "COMPUTE_WH"' >> connections.toml
          echo 'database = "SNOWFLAKE_SANDBOX_DB"' >> connections.toml
          echo 'schema = "PUBLIC"' >> connections.toml
          cat connections.toml  # Para verificar que se creÃ³ correctamente

      - name: ðŸ”¹ Probar conexiÃ³n con Snowflake
        run: |
          python -c "
          import snowflake.connector
          conn = snowflake.connector.connect(
              user='DUMAR',
              password='dfVTkMMXXskFH8w',
              account='aia76005.east-us-2.azure',
              warehouse='COMPUTE_WH',
              database='SNOWFLAKE_SANDBOX_DB',
              schema='PUBLIC'
          )
          print('âœ… ConexiÃ³n exitosa!')
          conn.close()
          "

      - name: ðŸ”¹ Ejecutar schemachange
        run: |
          schemachange -c connections.toml -f carpetas_de_migraciones -a aia76005.east-us-2.azure -u DUMAR -p dfVTkMMXXskFH8w
