name: Deploy to Snowflake with schemachange

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîπ Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: üîπ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: üîπ Instalar dependencias
        run: |
          pip install schemachange snowflake-connector-python

      - name: üîπ Crear archivo connections.toml
        run: |
          echo '[connections.snowflake]' > connections.toml
          echo 'account = "aia76005.east-us-2.azure"' >> connections.toml
          echo 'user = "DUMAR"' >> connections.toml
          echo 'password = "dfVTkMMXXskFH8w"' >> connections.toml
          echo 'role = "ACCOUNTADMIN"' >> connections.toml
          echo 'warehouse = "COMPUTE_WH"' >> connections.toml
          echo 'database = "SNOWFLAKE_SANDBOX_DB"' >> connections.toml
          echo 'schema = "PUBLIC"' >> connections.toml
          cat connections.toml  # Verificar contenido

      - name: üîπ Probar conexi√≥n con Snowflake
        run: |
          python -c "
          import snowflake.connector
          conn = snowflake.connector.connect(
              user='DUMAR',
              password='dfVTkMMXXskFH8w',
              account='aia76005.east-us-2.azure',
              warehouse='COMPUTE_WH',
              database='SNOWFLAKE_SANDBOX_DB',
              schema='PUBLIC'
          )
          print('‚úÖ Conexi√≥n exitosa!')
          conn.close()
          "

      - name: üìÇ Verificar directorio de migraciones
        run: ls -la migrations || echo "‚ö†Ô∏è Directorio 'migrations' no encontrado"

      - name: üîπ Ejecutar schemachange
        run: |
          schemachange deploy -c connections.toml -f migrations
